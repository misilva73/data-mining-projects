*------------------------------------------------------------*;
* EM SCORE CODE;
* EM Version: 14.2;
* SAS Release: 9.04.01M4P110916;
* Host: DESKTOP-61HCQ9U;
* Encoding: wlatin1;
* Locale: en_GB;
* Project Path: C:\Users\misil\Desktop\MIS;
* Project Name: DM1_project;
* Diagram Id: EMWS1;
* Diagram Name: Segmentation;
* Generated by: misil;
* Date: 22DEC2017:21:33:38;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* TOOL: Input Data Source;
* TYPE: SAMPLE;
* NODE: Ids;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* TOOL: Imputation;
* TYPE: MODIFY;
* NODE: Impt;
*------------------------------------------------------------*;
*;
*MOST FREQUENT VALUE (COUNT);
*;
length IMP_Children 8;
label IMP_Children = 'Imputed Children';
IMP_Children = Children;
if missing(Children) then IMP_Children = 1;
length IMP_EducDeg $25;
label IMP_EducDeg = 'Imputed EducDeg';
IMP_EducDeg = EducDeg;
if EducDeg = '' then IMP_EducDeg = '3 - BSc/MSc';
length IMP_GeoLivArea 8;
label IMP_GeoLivArea = 'Imputed GeoLivArea';
IMP_GeoLivArea = GeoLivArea;
if missing(GeoLivArea) then IMP_GeoLivArea = 4;
*;
*MEAN-MAX-MIN-MEDIAN-MIDRANGE AND ROBUST ESTIMATES;
*;
label IMP_BirthYear = 'Imputed BirthYear';
length IMP_BirthYear 8;
IMP_BirthYear = BirthYear;
if missing(BirthYear) then IMP_BirthYear = 1968;
label IMP_FirstPolYear = 'Imputed FirstPolYear';
length IMP_FirstPolYear 8;
IMP_FirstPolYear = FirstPolYear;
if missing(FirstPolYear) then IMP_FirstPolYear = 1986;
label IMP_MonthSal = 'Imputed MonthSal';
length IMP_MonthSal 8;
IMP_MonthSal = MonthSal;
if missing(MonthSal) then IMP_MonthSal = 2501.5;
label IMP_PremHealth = 'Imputed PremHealth';
length IMP_PremHealth 8;
IMP_PremHealth = PremHealth;
if missing(PremHealth) then IMP_PremHealth = 162.81;
label IMP_PremLife = 'Imputed PremLife';
length IMP_PremLife 8;
IMP_PremLife = PremLife;
if missing(PremLife) then IMP_PremLife = 25.56;
label IMP_PremMotor = 'Imputed PremMotor';
length IMP_PremMotor 8;
IMP_PremMotor = PremMotor;
if missing(PremMotor) then IMP_PremMotor = 298.61;
label IMP_PremWork = 'Imputed PremWork';
length IMP_PremWork 8;
IMP_PremWork = PremWork;
if missing(PremWork) then IMP_PremWork = 25.67;
*------------------------------------------------------------*;
* TOOL: Transform;
* TYPE: MODIFY;
* NODE: Trans;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* Formula Code;
*------------------------------------------------------------*;
revHealth =(IMP_PremHealth < 0) ;
revLife =(IMP_PremLife < 0) ;
revWork =(IMP_PremWork < 0) ;
revHousehold =(PremHousehold < 0) ;
revMotor =(IMP_PremMotor < 0) ;
*------------------------------------------------------------*;
* TOOL: Transform;
* TYPE: MODIFY;
* NODE: Trans2;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* Formula Code;
*------------------------------------------------------------*;
newPremHealth =IMP_PremHealth * ( NOT revHealth) ;
newPremLife =IMP_PremLife * ( NOT revLife) ;
newPremMotor =IMP_PremMotor * ( NOT revMotor) ;
newPremWork =IMP_PremWork * ( NOT revWork) ;
newPremHousehold =PremHousehold * ( NOT revHousehold) ;
*------------------------------------------------------------*;
* TOOL: Transform;
* TYPE: MODIFY;
* NODE: Trans3;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* Formula Code;
*------------------------------------------------------------*;
age =2016 - IMP_BirthYear ;
policy_time =2016 - IMP_FirstPolYear ;
reversals =revHealth + revHousehold + revLife + revMotor + revWork ;
*------------------------------------------------------------*;
* TOOL: Drop Node;
* TYPE: MODIFY;
* NODE: Drop;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* TOOL: Filtering;
* TYPE: MODIFY;
* NODE: Filter2;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* TOOL: Clustering;
* TYPE: EXPLORE;
* NODE: Clus2;
*------------------------------------------------------------*;
*****************************************;
*** Begin Scoring Code from PROC DMVQ ***;
*****************************************;


*** Begin Class Look-up, Standardization, Replacement ;
drop _dm_bad; _dm_bad = 0;

*** Standardize newPremHealth ;
drop T_newPremHealth ;
if missing( newPremHealth ) then T_newPremHealth = .;
else T_newPremHealth = (newPremHealth - 169.635180503589) * 0.01346436244109;

*** Standardize newPremHousehold ;
drop T_newPremHousehold ;
if missing( newPremHousehold ) then T_newPremHousehold = .;
else T_newPremHousehold = (newPremHousehold
         - 197.588431590653) * 0.00470478682718;

*** Standardize newPremLife ;
drop T_newPremLife ;
if missing( newPremLife ) then T_newPremLife = .;
else T_newPremLife = (newPremLife - 37.3322793002349) * 0.02644481356546;

*** Standardize newPremMotor ;
drop T_newPremMotor ;
if missing( newPremMotor ) then T_newPremMotor = .;
else T_newPremMotor = (newPremMotor - 305.97255839822) * 0.00754702532898;

*** Standardize newPremWork ;
drop T_newPremWork ;
if missing( newPremWork ) then T_newPremWork = .;
else T_newPremWork = (newPremWork - 37.4512539184974) * 0.02618215251777;

*** End Class Look-up, Standardization, Replacement ;


*** Omitted Cases;
if _dm_bad then do;
   _SEGMENT_ = .; Distance = .;
   goto CLUS2vlex ;
end; *** omitted;

*** Compute Distances and Cluster Membership;
label _SEGMENT_ = 'Segment Id' ;
label Distance = 'Distance' ;
array CLUS2vads [3] _temporary_;
drop _vqclus _vqmvar _vqnvar;
_vqmvar = 0;
do _vqclus = 1 to 3; CLUS2vads [_vqclus] = 0; end;
if not missing( T_newPremHealth ) then do;
   CLUS2vads [1] + ( T_newPremHealth - -0.82960024900408 )**2;
   CLUS2vads [2] + ( T_newPremHealth - 0.78787937450745 )**2;
   CLUS2vads [3] + ( T_newPremHealth - 0.08379147181449 )**2;
end;
else _vqmvar + 1;
if not missing( T_newPremHousehold ) then do;
   CLUS2vads [1] + ( T_newPremHousehold - -0.56381216035569 )**2;
   CLUS2vads [2] + ( T_newPremHousehold - -0.08291993090175 )**2;
   CLUS2vads [3] + ( T_newPremHousehold - 1.39128804971018 )**2;
end;
else _vqmvar + 1;
if not missing( T_newPremLife ) then do;
   CLUS2vads [1] + ( T_newPremLife - -0.59663170306057 )**2;
   CLUS2vads [2] + ( T_newPremLife - -0.02476874382712 )**2;
   CLUS2vads [3] + ( T_newPremLife - 1.33638054355613 )**2;
end;
else _vqmvar + 1;
if not missing( T_newPremMotor ) then do;
   CLUS2vads [1] + ( T_newPremMotor - 0.99564167646414 )**2;
   CLUS2vads [2] + ( T_newPremMotor - -0.41156858709146 )**2;
   CLUS2vads [3] + ( T_newPremMotor - -1.25283673419627 )**2;
end;
else _vqmvar + 1;
if not missing( T_newPremWork ) then do;
   CLUS2vads [1] + ( T_newPremWork - -0.59394228147834 )**2;
   CLUS2vads [2] + ( T_newPremWork - -0.01546512504312 )**2;
   CLUS2vads [3] + ( T_newPremWork - 1.31052205167744 )**2;
end;
else _vqmvar + 1;
_vqnvar = 5 - _vqmvar;
if _vqnvar <= 2.8421709430404E-12 then do;
   _SEGMENT_ = .; Distance = .;
end;
else do;
   _SEGMENT_ = 1; Distance = CLUS2vads [1];
   _vqfzdst = Distance * 0.99999999999988; drop _vqfzdst;
   do _vqclus = 2 to 3;
      if CLUS2vads [_vqclus] < _vqfzdst then do;
         _SEGMENT_ = _vqclus; Distance = CLUS2vads [_vqclus];
         _vqfzdst = Distance * 0.99999999999988;
      end;
   end;
   Distance = sqrt(Distance * (5 / _vqnvar));
end;
CLUS2vlex :;

***************************************;
*** End Scoring Code from PROC DMVQ ***;
***************************************;
*------------------------------------------------------------*;
* Clus2: Creating Segment Label;
*------------------------------------------------------------*;
length _SEGMENT_LABEL_ $80;
label _SEGMENT_LABEL_='Segment Description';
if _SEGMENT_ = 1 then _SEGMENT_LABEL_="Cluster1";
else
if _SEGMENT_ = 2 then _SEGMENT_LABEL_="Cluster2";
else
if _SEGMENT_ = 3 then _SEGMENT_LABEL_="Cluster3";
*------------------------------------------------------------*;
* TOOL: Score Node;
* TYPE: ASSESS;
* NODE: Score;
*------------------------------------------------------------*;
*------------------------------------------------------------*;
* Score: Creating Fixed Names;
*------------------------------------------------------------*;
LABEL EM_SEGMENT = 'Segment Variable';
EM_SEGMENT = _SEGMENT_;
